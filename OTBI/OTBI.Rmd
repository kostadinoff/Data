---
title: "OTBI"
output: html_notebook
---

# Оценка на разходите

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, cache.lazy = FALSE, warning = FALSE, message = FALSE, echo = TRUE, dpi = 180, fig.width = 8, fig.height = 5)
library(tidyverse)
library(silgelib)
theme_set(theme_plex())
update_geom_defaults("rect", list(fill = "midnightblue", alpha = 0.8))
library(gt)
library(lubridate)
library(extrafont)
loadfonts(device = "win")
library(ggplot2)
library(flextable)
library(tidytext)
```

От данните на НЗОК за разходи за медикаментозно лечение през периода 2017-2021 г. са филтрирани разходите таргетните медикаменти. Разходите са представени в тримесечен период. 

```{r}
#зареждане на данните за разходите
rdf <- read.csv("https://raw.githubusercontent.com/kostadinoff/Data/main/OTBI/rdf_cost.csv", stringsAsFactors=TRUE) %>% 
as_tibble() %>% 
  select(-"X")
# деклариране на данните като дата
rdf$date <- dmy(rdf$date)
rdf$date = as.Date(rdf$date)

```

```{r таблица 1, echo=TRUE, message=FALSE, warning=FALSE, paged.print=TRUE}
costs = rdf %>% 
  group_by(year_Q) %>% 
  dplyr::summarise(sum(QV)) %>% 
  flextable()
costs
```

Най-висок разход за медикаментите в интерес на изследването са осъществени през четвъртото тримесечие на 2020г. като възлизат на $675,710,011$ лв. Най-ниските разходи се наблюдават в началото на периода при въвеждането на оценката на здравни технологии и възлиза на $8,192,903$. 

```{r фигура 1, echo=TRUE, message=FALSE, warning=FALSE}
plot_Q_cost = rdf %>% 
  group_by(year_Q) %>% 
  dplyr::summarise(sum= sum(QV)) %>% 
  ggplot(aes(year_Q, sum, fill= year_Q))+
  geom_col()+
  scale_y_continuous(labels=scales::dollar_format(scale = .001, suffix = " мил.лв", prefix = " "))+
  coord_flip()+
  theme(legend.position="none")+
  labs(title= "Разходи на НЗОК за таргетни онкологични медикаменти", subtitle = " в милиони лева, по тримесечие",
       y=" ", x= " ")
  
plot_Q_cost
```
```{r фигура 2, echo=TRUE, fig.height=20, fig.width=7, message=FALSE, warning=FALSE}
cost_per_INN = 
  rdf %>% 
  group_by(INN, year) %>% 
  dplyr::summarise(sum= sum(QV)) %>% 
  ungroup() %>% 
  mutate(INN = as.factor(INN),
           INN = reorder_within(INN, sum, year)) %>%
  ggplot(aes(INN, log(sum,10), fill=INN)) +
  geom_col()+
  facet_wrap(~year, scales = "free_y", ncol = 1)+
  coord_flip()+
  scale_x_reordered()+
  theme(legend.position="none")+
  labs(title= "Разходи на НЗОК за таргетни онкологични медикаменти",
       y=" десетичен логаритъм на разходите", x= " ") + theme(axis.title = element_text(family = "Courier")) +labs(alpha = 0.6)
cost_per_INN
```

```{r фигура 3, echo=TRUE, message=FALSE, warning=FALSE}
time_df= rdf %>% 
  group_by(year_Q) %>% 
  summarise(cost= sum(QV)) %>% 
  mutate(rate = ((cost-lag(cost))/lag(cost))) %>%
  ungroup() %>% 
  ggplot(mapping=aes(x=year_Q, y=rate, fill=year_Q)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent)+
  coord_flip()+
  theme(legend.position="none")+
  labs(title= " Верижен индекс на промяна по отчетни тримесечия", y=" % промяна", x= " ") 
  
time_df

 
```

